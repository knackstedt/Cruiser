<app-headerbar label="Pipelines"></app-headerbar>

<div #scroller class="scroller" (scroll)="onScroll(scroller)" cdkDropListGroup style="height: 100%; overflow: auto">
    <!-- NgFor swimlane -->
    <mat-accordion
        *ngFor="let group of pipelineGroups"
        displayMode="flat"
        [multi]="true"
    >
        <mat-expansion-panel expanded="true">
        <!-- (pointerenter)="btn['_hover'] = true"
            (pointerleave)="btn['_hover'] = false" -->
            <mat-expansion-panel-header>
                <div class="label">
                    {{group.label || "unknown"}}
                </div>

                <!-- <button
                    #btn
                    mat-icon-button
                    matTooltip="Add a pipeline"
                    class="add-button"
                    [style.opacity]="btn['_hover'] ? 1 : 0"
                    (click)="createPipeline({group: group.label})"
                >
                    <mat-icon>add</mat-icon>
                </button> -->
            </mat-expansion-panel-header>

            <div
                #grid
                class="grid"
                [attr.pipeline-group]="group.label"
            >

                <div
                    class="grid-item"
                    *ngFor="let pipeline of group.items"
                    [ngx-ctx-menu]="ctxMenu"
                    [ngx-ctx-menu-context]="pipeline"
                    [attr.pipeline-id]="pipeline.id"
                >
                    <!-- <mat-icon [fontIcon]="data._icon || 'task'"></mat-icon> -->
                    <div class="content">
                        <!-- <button><mat-icon>settings</mat-icon></button> -->
                        <h4 class="label">{{pipeline.label}}</h4>

                        <div class="schedule-controls">

                            <button [disabled]="pipeline.state != 'active'" (click)="triggerPipeline(pipeline)"><mat-icon>play_arrow</mat-icon></button>
                            <button [disabled]="pipeline.state != 'active'" (click)="triggerPipelineWithOptions(pipeline)"><img icon="play-with-options"/></button>
                            <button [class.active]="pipeline.state == 'active'" (click)="pipeline.state == 'active' ? pausePipeline(pipeline) : resumePipeline(pipeline)">
                                <mat-icon>pause</mat-icon>
                            </button>

                            <a href="#/History">History</a>
                        </div>
                        <hr/>
                        <div>
                            <div>Instance: {{((pipeline.stages||[])[0]?.jobs||[])[0]?.invocationCount}}</div>

                            <div>
                                <a href="#/Compare">Compare</a>
                                <a href="#/Changes">Changes</a>
                                <a href="#/VSM">VSM</a>
                            </div>

                            <div>Triggered by {{((pipeline.stages||[])[0]?.jobs||[])[0]?.lastTriggerReason}} on {{((pipeline.stages||[])[0]?.jobs||[])[0]?.lastRun}} Local Time</div>
                        </div>
                        <div>
                            <div *ngFor="let stage of pipeline.stages">
                                <!-- check block cancel-->
                                <mat-icon [fontIcon]="stage.jobs[0].runState"></mat-icon>
                            </div>
                        </div>

                        <button class="options" mat-icon-button [ngx-app-menu]="ctxMenu" [ngx-app-menu-context]="pipeline">
                            <mat-icon>more_vert</mat-icon>
                        </button>
                    </div>
                </div>
            </div>

            <div *ngIf="!group.items || group.items.length == 0" class="empty-placeholder">
                <span>No Pipelines</span>
            </div>
        </mat-expansion-panel>
    </mat-accordion>
</div>
